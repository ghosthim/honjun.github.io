title: 消息加解密 —— 微信公众平台开发
author: hojun
avatar: /images/favicon.png
authorDesc: 一个好奇的人
categories: 技术
date: 2017-07-05 23:08:38
authorLink:
authorAbout:
tags:
 - weixin
keywords: 微信消息加解密
description:
photos:
---
推荐 [方倍工作室](http://www.cnblogs.com/txw1958/)
参照 http://www.cnblogs.com/txw1958/p/weixin-aes-encrypt-decrypt.html
基于thinkphp3.2框架实现

## **第一步token验证**
![006bYVyvgy1fhai6wwexoj30qf0fmt96.jpg](https://wx3.sinaimg.cn/large/006bYVyvgy1fhai6wwexoj30qf0fmt96.jpg)
<font color="red">注意:上图的url地址对应index方法</font>
控制器代码：<font color="2ecc71">\Wx\Controller\IndexController.class.php</font>
```php
<?php
namespace Wx\Controller;
use Think\Controller;
class IndexController extends Controller {
    public function index() {
        if (!isset($_GET['echostr'])) {
            $this->getWxCrypt();
            $this->responseMsg();
        }else{
            $this->valid();
        }
    }

    //验证签名
    private function valid()
    {
        $echoStr = I("get.echostr");
        $signature = I("get.signature");
        $timestamp = I("get.signature");
        $nonce = I("get.nonce");
        $tmpArr = array(C('TOKEN'), $timestamp, $nonce);
        sort($tmpArr, SORT_STRING);
        $tmpStr = implode($tmpArr);
        $tmpStr = sha1($tmpStr);
        if($tmpStr == $signature){
            echo $echoStr;
            exit;
        }
    }
}
```
配置文件：
<font color="#2ece71">\Wx\Conf\config.php</font>
```conf
<?php
return array(
	//'配置项'=>'配置值'

    // 加载扩展的微信配置文件 weixin.php
    'LOAD_EXT_CONFIG' => 'weixin',
);
```
<font color="#2ece71">\Wx\Conf\weixin.php</font>
```
<?php
//微信配置文件
return array(
    'TOKEN' => '你的token',
    'APPID' => '你的APPID',
    'APPSECRET' => '你的AppSecret',
    'OLDENCODINGAESKEY' => '',
    'NEWENCODINGAESKEY' => '你的EncodingAESKey',
);
```
验证成功即可提交配置

## **第二步消息加解密**
控制器代码：<font color="red">注意：和之前代码有区别</font>
```php
<?php
namespace Wx\Controller;
use Wx\Controller\AppBaseController;
class IndexController extends Controller {
    
    protected $wxCrypt;

    public function index() {
        $echostr = I("get.echostr");
        if (empty($echostr)) {
            $this->getWxCrypt(C('NEWENCODINGAESKEY'));
            $this->responseMsg();
        }else{
            $this->valid();
        }
    }

    //验证签名
    private function valid()
    {
        $echoStr = I("get.echostr");
        $signature = I("get.signature");
        $timestamp = I("get.timestamp");
        $nonce = I("get.nonce");
        $tmpArr = array(C('TOKEN'), $timestamp, $nonce);
        sort($tmpArr, SORT_STRING);
        $tmpStr = implode($tmpArr);
        $tmpStr = sha1($tmpStr);
        if($tmpStr == $signature){
            echo $echoStr;
            exit;
        }
    }

    //响应消息
    private function responseMsg()
    {
        $postData = $GLOBALS["HTTP_RAW_POST_DATA"];
        // $postData = file_get_contents("php://input");
        
        // 第三方收到公众号平台发送的消息
        $msg = '';
        $errCode = $this->wxCrypt->decryptMsg(I("get.msg_signature"), I("get.timestamp"), I("get.nonce"), $postData, $msg);
        if ($errCode != 0) {
            //尝试之前的encodingAESKey解密
            $this->getWxCrypt(C('OLDENCODINGAESKEY'));
            $errCode = $this->wxCrypt->decryptMsg(I("get.msg_signature"), I("get.timestamp"), I("get.nonce"), $postData, $msg);
            if ($errCode != 0) {
                //解密失败
                print("解密失败: ".$errCode . "\n");
                exit();
            }
        }

        if (!empty($msg)){
            $postObj = simplexml_load_string($msg, 'SimpleXMLElement', LIBXML_NOCDATA);
            $MsgType = trim($postObj->MsgType);

            // if (($postObj->MsgType == "event") && ($postObj->Event == "subscribe" || $postObj->Event == "unsubscribe")){
            //过滤关注和取消关注事件
            // }else{
                
            // }
            
            //消息类型分离
            switch ($MsgType)
            {
                case "text":
                    $result = $this->receiveText($postObj);
                    break;
                default:
                    $result = "unknown msg type: ".$MsgType;
                    break;
            }
            echo $result;
        }else {
            echo "";
            exit;
        }
    }

    //接收文本消息
    private function receiveText($object)
    {
        $keyword = trim($object->Content);
           
        $content = "这是个文本消息";

        $result = $this->transmitText($object, $content);
        return $result;
    }


    //回复文本消息
    private function transmitText($object, $content)
    {
        if (!isset($content) || empty($content)){
            return "";
        }

        $xmlTpl = "<xml><ToUserName><![CDATA[%s]]></ToUserName><FromUserName><![CDATA[%s]]></FromUserName><CreateTime>%s</CreateTime><MsgType><![CDATA[text]]></MsgType><Content><![CDATA[%s]]></Content></xml>";
        $result = sprintf($xmlTpl, $object->FromUserName, $object->ToUserName, time(), $content);
        
        $encryptMsg = '';
        $errCode = $this->wxCrypt->encryptMsg($result, time(), $object->nonce, $encryptMsg);
        if ($errCode != 0) {
            print("加密后: " . $encryptMsg . "\n");
        }

        return $encryptMsg;
    }

    //获取WxCrypt对象
    private function getWxCrypt($encodingAESKey) {
        import('Vendor.Weixin.WXBizMsgCrypt');
        $this->wxCrypt = new \WXBizMsgCrypt(C('TOKEN'), $encodingAESKey, C('APPID'));
    }
}
```
<font color="red">注意：Vendor.Weixin.WXBizMsgCrypt是微信提供的加解密demo代码，自己集成到了tp的<font color="#2ece71">\ThinkPHP\Library\Vendor\Weixin\下</font>