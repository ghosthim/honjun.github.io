<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" /> 
  <style type="text/css">
    img {
      width: 100%;
      height: 100%;
    }
    .set {
    }
    .show {
      position: relative;
      width: 100%;
    }
    .bg {
      width: 100%;
    }
    .content {
      position: absolute;
      display: flex;
      float: left;
      flex-direction: column;
      top: 15%;
      width: 100%;
      height: 76%;
    }
    .item {
      flex: 1;
      flex-shrink: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-content: space-between;
      box-sizing: border-box;
    }
    .text {
      width: 100%;
      height: 100%;
      margin: 0px 5px 5px 5px;
    }
    .pin {
      flex: 1;
      padding: 5px;
    }
  </style>
</head>
<body style="background: #000;">
  <div id="root">
    <div class="set">
      <input type="file" id="one" name="one" />
      <input type="file" id="two" name="two" />
      <input type="file" id="three" name="three" />
      <input type="file" id="four" name="four" />
      <textarea id="textarea" name="text" placeholder="请输入文字"></textarea>
      <button id="write">插入文字</button>
      <button id="save">下载</button>
    </div>
    <div class="show" id="show">
      <img class="bg" src="./img/background.jpg"/>
      <div class="content">
        <div class="item">
          <span class="pin">
            <img id="img1" src="./img/1.jpg"/>
          </span>
          <span class="pin">
            <img id="img2" src="./img/2.jpg"/>
          </span>
        </div>
        <div class="item">
          <span class="pin">
            <img id="img3" src="./img/3.jpg"/>
          </span>
          <span class="pin">
            <img id="img4" src="./img/4.jpg"/>
          </span>
        </div>
        <div class="item">
          <div class="text" id="text">请输入文字请输入文字请输入文字请输入文字</div>
        </div>
      </div>
    </div>
    <img id="imgs"/>
  </div>
</body>
<script type="text/javascript" src="./js/html2canvas.js"></script>
<script type="text/javascript" src="./js/canvas2image.js"></script>
<script type="text/javascript">
  window.onload=function(){
    $write = document.getElementById('write');
    $textarea = document.getElementById('textarea');
    $save = document.getElementById('save');
    $imgs = document.getElementById('imgs');
    $one = document.getElementById('one');
    $two = document.getElementById('two');
    $three = document.getElementById('three');
    $four = document.getElementById('four');
    
    $one.onchange = function (e) {
      var $img1 = document.getElementById('img1');
      var reader = new FileReader();
        reader.readAsDataURL(this.files[0]);
        reader.onload = function (e) { 
          $img1.setAttribute('src',this.result); 
        }
    }
    $two.onchange = function (e) {
      var $img1 = document.getElementById('img2');
      var reader = new FileReader();
        reader.readAsDataURL(this.files[0]);
        reader.onload = function (e) { 
          $img1.setAttribute('src',this.result); 
        }
    }
    $three.onchange = function (e) {
      var $img1 = document.getElementById('img3');
      var reader = new FileReader();
        reader.readAsDataURL(this.files[0]);
        reader.onload = function (e) { 
          $img1.setAttribute('src',this.result); 
        }
    }
    $four.onchange = function (e) {
      var $img1 = document.getElementById('img4');
      var reader = new FileReader();
        reader.readAsDataURL(this.files[0]);
        reader.onload = function (e) { 
          $img1.setAttribute('src',this.result); 
        }
    }

    $write.onclick = function (e) {
      var text = document.getElementById("text");
      var width = text.offsetWidth;
      var height = text.offsetHeight;
      var L=0.0;
      var str = '  ' + $textarea.value;
      text.innerText = str;
      for(var i in str){
          L+=(str.charCodeAt(i)>255)?1:0.5;
      }
      L=Math.ceil(L);
      var font_size=Math.floor(Math.sqrt(parseInt(width)*parseInt(height)/L)*0.75);
      text.style.fontSize = font_size + 'px';
      text.style.textIndent = font_size * 2 + 'px';
      var parent=document.getElementById("root");
      var child=document.getElementsByTagName("canvas")[0];
      parent.removeChild(child);
      html2canvas(document.getElementById("show")).then(function(canvas) {
        document.getElementById("root").appendChild(canvas);
      });
    }

    $save.onclick = function (e) {
      var canvas = document.getElementsByTagName("canvas")[0];
      var w = canvas.offsetwidth;
      var h = canvas.offsetHeight;
      var ctx = canvas.getContext('2d');
      //画图
      ctx.drawImage(imgs, 0, 0, w, h);
      var data = canvas.toDataURL('image/jpeg');
      imgs.setAttribute('src', data);
    }
  }
</script>
</html>